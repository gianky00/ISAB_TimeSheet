name: Jules Auto-Fix on CI Failure

on:
  workflow_run:
    workflows: ["Python CI"]
    types:
      - completed

jobs:
  fix-with-jules:
    runs-on: ubuntu-latest
    # Solo se il CI è fallito
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          
      - name: Get failed workflow logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Scarica i log del workflow fallito
          gh run view ${{ github.event.workflow_run.id }} --log-failed > failed_logs.txt 2>&1 || true
          echo "FAILED_LOGS<<EOF" >> $GITHUB_ENV
          tail -200 failed_logs.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Invoke Jules to fix CI
        uses: google-labs-code/jules-invoke@v1
        with:
          prompt: |
            Il workflow CI "Python CI" è fallito. Analizza i log e correggi il problema.
            
            ## Log dell'errore:
            ${{ env.FAILED_LOGS }}
            
            ## Commit che ha causato il fallimento:
            Branch: ${{ github.event.workflow_run.head_branch }}
            SHA: ${{ github.event.workflow_run.head_sha }}
            
            ## Istruzioni:
            1. Analizza l'output per capire cosa è fallito
            2. Se sono test falliti, correggi il codice sorgente
            3. Se è un problema di dipendenze, aggiorna requirements.txt
            4. Se è un problema di configurazione, correggi i file di config
            5. Esegui i test localmente per verificare la fix
            6. Crea una PR con la correzione
            
            ## Vincoli:
            - Non disabilitare test per farli passare
            - Mantieni la retrocompatibilità
            - Se non riesci a identificare il problema, descrivi cosa hai trovato nella PR
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          starting_branch: ${{ github.event.workflow_run.head_branch }}
          include_last_commit: true
