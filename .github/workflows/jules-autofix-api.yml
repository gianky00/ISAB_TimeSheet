name: Jules Auto-Fix on CI Failure

on:
  workflow_run:
    workflows: ["Python Tests"]
    types:
      - completed

concurrency:
  group: jules-autofix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  fix-with-jules:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          
      - name: Get failed workflow logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log-failed > failed_logs.txt 2>&1 || true
          # TAIL prende gli ULTIMI 4000 caratteri dove ci sono gli errori
          tail -c 4000 failed_logs.txt > failed_logs_truncated.txt
          
      - name: Invoke Jules via API
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
          REPO_NAME: ${{ github.repository }}
        run: |
          SOURCE_RESPONSE=$(curl -s 'https://jules.googleapis.com/v1alpha/sources' \
            -H "X-Goog-Api-Key: $JULES_API_KEY")
          
          SOURCE_NAME=$(echo "$SOURCE_RESPONSE" | jq -r ".sources[] | select(.id | contains(\"$REPO_NAME\")) | .name" | head -1)
          
          if [ -z "$SOURCE_NAME" ] || [ "$SOURCE_NAME" = "null" ]; then
            echo "Repo non trovato in Jules. Collegalo su jules.google"
            exit 1
          fi
          
          echo "Source: $SOURCE_NAME"
          
          jq -n \
            --arg logs "$(<failed_logs_truncated.txt)" \
            --arg branch "$BRANCH_NAME" \
            --arg source "$SOURCE_NAME" \
            '{
              prompt: ("Il workflow CI e fallito. Analizza i log e correggi il problema.\n\nLog errore (ultimi 4000 caratteri):\n" + $logs + "\n\nBranch: " + $branch + "\n\nIstruzioni: Analizza i log, identifica la causa del fallimento, correggi il problema (codice, test, dipendenze o config), verifica che i test passino, crea una PR."),
              sourceContext: {
                source: $source,
                githubRepoContext: {
                  startingBranch: $branch
                }
              },
              automationMode: "AUTO_CREATE_PR",
              title: "Fix CI failure"
            }' > request.json
          
          RESPONSE=$(curl -s 'https://jules.googleapis.com/v1alpha/sessions' \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -d @request.json)
          
          echo "Risposta Jules:"
          echo "$RESPONSE" | jq .
          
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id')
          if [ -n "$SESSION_ID" ] && [ "$SESSION_ID" != "null" ]; then
            echo "Sessione Jules creata: $SESSION_ID"
          else
            echo "Errore creazione sessione"
            exit 1
          fi
