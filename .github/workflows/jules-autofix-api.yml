name: Jules Auto-Fix on CI Failure

on:
  workflow_run:
    workflows: ["Python Tests"]
    types:
      - completed

# UN SOLO TASK ALLA VOLTA per branch - evita task paralleli
concurrency:
  group: jules-autofix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  fix-with-jules:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          
      - name: Get failed workflow logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log-failed > failed_logs.txt 2>&1 || true
          head -c 3000 failed_logs.txt > failed_logs_truncated.txt
          
      - name: Invoke Jules via API
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          SOURCE_RESPONSE=$(curl -s 'https://jules.googleapis.com/v1alpha/sources' \
            -H "X-Goog-Api-Key: $JULES_API_KEY")
          
          REPO_NAME="${{ github.repository }}"
          SOURCE_NAME=$(echo "$SOURCE_RESPONSE" | jq -r ".sources[] | select(.id | contains(\"$REPO_NAME\")) | .name" | head -1)
          
          if [ -z "$SOURCE_NAME" ] || [ "$SOURCE_NAME" = "null" ]; then
            echo "‚ùå Repo non trovato in Jules. Collegalo su jules.google"
            exit 1
          fi
          
          echo "‚úÖ Source: $SOURCE_NAME"
          
          LOGS_CONTENT=$(cat failed_logs_truncated.txt)
          
          PROMPT="Il workflow CI √® fallito. Analizza i log e correggi il problema.

## Log dell'errore:
$LOGS_CONTENT

## Branch: ${{ github.event.workflow_run.head_branch }}

## Istruzioni:
Analizza attentamente i log e identifica la causa esatta del fallimento.
Correggi il problema, che sia nel codice sorgente, nei test, nelle dipendenze, nella configurazione o in qualsiasi altro file.
Esegui i test per verificare che la correzione funzioni.
Crea una PR con la fix."
          
          RESPONSE=$(curl -s 'https://jules.googleapis.com/v1alpha/sessions' \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              --arg source "$SOURCE_NAME" \
              --arg branch "${{ github.event.workflow_run.head_branch }}" \
              '{
                prompt: $prompt,
                sourceContext: {
                  source: $source,
                  githubRepoContext: {
                    startingBranch: $branch
                  }
                },
                automationMode: "AUTO_CREATE_PR",
                title: "Fix CI failure"
              }')")
          
          echo "Risposta Jules:"
          echo "$RESPONSE" | jq .
          
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id')
          if [ -n "$SESSION_ID" ] && [ "$SESSION_ID" != "null" ]; then
            echo "‚úÖ Sessione Jules creata: $SESSION_ID"
            echo "üîó https://jules.google"
          else
            echo "‚ùå Errore creazione sessione"
            exit 1
          fi
